FROM gcc AS build

WORKDIR /root
RUN wget https://github.com/openssl/openssl/archive/refs/tags/openssl-3.0.7.zip \
    && unzip openssl-3.0.7.zip \
    && mv openssl-openssl-3.0.7 openssl \
    && cd openssl \
    && ./Configure no-tests -debug -static \
    && sed -i 's/^CFLAGS=.*/CFLAGS=-Wall -Og -g3/' Makefile \
    && make -j`nproc`
COPY . .
RUN ./gen.sh

FROM busybox
COPY --from=build /root/openssl/apps/openssl /usr/bin/openssl
RUN mkdir /certs
COPY --from=build /root/certs/cacert.pem /root/certs/client.*pem /certs/
ENTRYPOINT [ "/bin/sh", "-c" ]
CMD [ "openssl s_client -connect $HOSTNAME:$PORT -key /certs/client.key.pem -cert /certs/client.cert.pem -CAfile /certs/cacert.pem -state" ]